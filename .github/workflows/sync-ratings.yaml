name: Sync Paper Ratings
on:
  schedule:
    - cron: '0 * * * *' # Runs every hour
  workflow_dispatch: # Allows you to run it manually for testing

jobs:
  collect-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Fetch and Process Reactions
        uses: actions/github-script@v7
        id: gather-data
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'paper',
              state: 'open'
            });

            const ratings = [];

            for (const issue of issues.data) {
              // 1. Find the bot's comment on this issue
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });

              // Change 'Bot Welcome' to a unique string in your actual comment
              const targetComment = comments.data.find(c => c.body.includes('Use this meta-comment to react to this paper'));

              if (targetComment) {
                // 2. Get reactions for that specific comment
                const reactions = await github.rest.reactions.listForIssueComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: targetComment.id
                });

                // 3. Simplify the data for your web page
                ratings.push({
                  issue_number: issue.number,
                  title: issue.title,
                  url: issue.html_url,
                  reaction_counts: reactions.data.reduce((acc, r) => {
                    acc[r.content] = (acc[r.content] || 0) + 1;
                    return acc;
                  }, {})
                });
              }
            }
            
            // Write to a file
            const fs = require('fs');
            fs.writeFileSync('ratings.json', JSON.stringify(ratings, null, 2));

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ratings.json
          git commit -m "docs: update paper ratings" || echo "No changes to commit"
          git push
