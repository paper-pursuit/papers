name: Sync Paper Ratings
on:
  schedule:
    - cron: '0 * * * *' # Runs every hour
  workflow_dispatch: # Allows you to run it manually for testing

jobs:
  collect-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Fetch and Process Reactions
        uses: actions/github-script@v7
        id: gather-data
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'paper',
              state: 'open'
            });

            const ratings = [];

            for (const issue of issues.data) {
              // 1. Extract Heading from Body using Regex
              // Looks for # followed by a space, then captures everything until the end of the line
              const titleMatch = issue.body ? issue.body.match(/^#\s+(.+)$/m) : null;
              const extractedTitle = titleMatch ? titleMatch[1].trim() : "No Title Found";

              // 2. Filter labels (exclude 'paper')
              const tags = issue.labels
                .map(l => l.name)
                .filter(name => name !== 'paper');

              // 3. Find the bot's comment
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });

              const targetComment = comments.data.find(c => c.body.includes("ðŸš€ We've received your report"));

              if (targetComment) {
                const reactions = await github.rest.reactions.listForIssueComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: targetComment.id
                });

                ratings.push({
                  issue_number: issue.number,
                  display_title: extractedTitle, // The # Heading title
                  github_title: issue.title,     // The actual Issue title
                  tags: tags,                    // All other labels
                  url: issue.html_url,
                  reaction_counts: reactions.data.reduce((acc, r) => {
                    acc[r.content] = (acc[r.content] || 0) + 1;
                    return acc;
                  }, {})
                });
              }
            }
            
            const fs = require('fs');
            fs.writeFileSync('public/ratings.json', JSON.stringify(ratings, null, 2));

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add public/ratings.json
          git commit -m "docs: update paper ratings" || echo "No changes to commit"
          git push
